# Convex Deployment Guide

This project is configured for deployment on Convex - a serverless backend platform perfect for long-running AI tasks!

## üéØ Why Convex is Perfect for This Project

- ‚úÖ **No Timeout Limits** - Background actions can run as long as needed (AI processing takes 2-5 min)
- ‚úÖ **Built-in File Storage** - No need for S3 or external storage
- ‚úÖ **Real-time Updates** - Better than WebSockets, built-in reactivity
- ‚úÖ **Generous Free Tier** - Perfect for personal projects
- ‚úÖ **Automatic Scaling** - Handles traffic spikes automatically

## Prerequisites

1. [Convex account](https://www.convex.dev/) (free tier available)
2. [Replicate API token](https://replicate.com/account/api-tokens)
3. Node.js 18+ installed

## Quick Deploy

### 1. Install Convex CLI

```bash
npm install
npm install -g convex
```

### 2. Login to Convex

```bash
npx convex login
```

This opens your browser to authenticate.

### 3. Initialize Convex Project

```bash
npx convex dev
```

This will:
- Create a new Convex project
- Set up the database schema
- Deploy your functions
- Start local development server

### 4. Set Environment Variables

In your Convex dashboard (https://dashboard.convex.dev):

1. Select your project
2. Go to "Settings" ‚Üí "Environment Variables"
3. Add:
   - `REPLICATE_API_TOKEN` = `r8_your_token_here`

### 5. Deploy to Production

```bash
npm run deploy
```

Or:

```bash
npx convex deploy
```

Your app is now live! üöÄ

## Project Structure

```
convex/
‚îú‚îÄ‚îÄ http.js          # HTTP endpoints (API routes)
‚îú‚îÄ‚îÄ restoration.js   # Mutations, queries, and background actions
‚îú‚îÄ‚îÄ schema.js        # Database schema
‚îî‚îÄ‚îÄ _generated/      # Auto-generated by Convex
```

## How It Works

### HTTP Endpoints (convex/http.js)

Handles all web requests:
- `GET /` - Serves the web UI
- `POST /api/upload` - Uploads files to Convex storage
- `POST /api/restore` - Starts a restoration job
- `GET /api/jobs/:id` - Checks job status
- `GET /api/download/:fileId` - Downloads restored PDF

### Background Actions (convex/restoration.js)

Long-running AI restoration happens here with **no timeout limits**:
- `processRestorationJob` - Runs the entire restoration pipeline
- Updates progress in real-time
- Stores result in Convex storage

### Database (convex/schema.js)

Stores job metadata:
```javascript
{
  status: "pending" | "processing" | "completed" | "failed",
  fileId: "storage_id",
  options: { scale, dpi, aiDamageRestoration, ... },
  progress: 0-100,
  result: { outputFileId },
  error: "error message if failed"
}
```

## Environment Variables

Set these in Convex Dashboard ‚Üí Settings ‚Üí Environment Variables:

| Variable | Value | Required |
|----------|-------|----------|
| `REPLICATE_API_TOKEN` | Your Replicate API token | ‚úÖ Yes |

## Features on Convex

### ‚úÖ Works Perfectly
- Long-running AI restoration (no timeouts!)
- File uploads and downloads
- Real-time job status updates
- PDF generation and export
- All restoration features

### ‚ö†Ô∏è Requires Adaptation
- **WebSockets**: Not needed! Convex has built-in real-time reactivity
- **File System**: Use Convex storage instead of local files

## Local Development

Run locally with live reload:

```bash
npm run dev
```

Or:

```bash
npx convex dev
```

This runs:
- Convex backend locally
- Auto-syncs code changes
- Connects to cloud database

Then in another terminal, serve the frontend:

```bash
npm run server
```

## Deployment Checklist

- [ ] Convex account created
- [ ] `npm install` completed
- [ ] `npx convex login` authenticated
- [ ] `npx convex dev` initialized project
- [ ] `REPLICATE_API_TOKEN` added in Convex dashboard
- [ ] `npx convex deploy` deployed to production
- [ ] Test upload and restoration

## Integrating Your Restoration Code

The placeholder in `convex/restoration.js` needs your actual restoration logic. Here's how to adapt it:

### Option 1: Import Existing Functions

```javascript
// In convex/restoration.js
import { restorePage } from "../src/restore.js";
import { AIDamageRestoration } from "../src/ai-damage-restoration.js";
import { createMultiPagePDF } from "../src/pdf-export.js";

export const processRestorationJob = action({
  args: { jobId: v.id("jobs") },
  handler: async (ctx, args) => {
    // ... existing job setup code ...
    
    // Call your existing functions
    const restored = await restorePage(inputBuffer, job.options);
    
    // Generate PDF
    const pdf = await createMultiPagePDF([restored], job.options);
    
    // Store in Convex storage
    const outputFileId = await ctx.storage.store(new Blob([pdf]));
    
    // Mark job as complete
    await ctx.runMutation(api.restoration.completeJob, {
      jobId: args.jobId,
      outputFileId,
    });
  },
});
```

### Option 2: Use Convex Actions for External API Calls

Convex actions can call external APIs (like Replicate) directly:

```javascript
import Replicate from "replicate";

export const processRestorationJob = action({
  handler: async (ctx, args) => {
    const replicate = new Replicate({
      auth: process.env.REPLICATE_API_TOKEN,
    });
    
    // Call Replicate API
    const output = await replicate.run(
      "nightmareai/real-esrgan:...",
      { input: { image: imageUrl } }
    );
    
    // Process and store result
    // ...
  },
});
```

## Cost Considerations

### Convex Free Tier
- 1M function calls/month
- 1 GB database storage
- 1 GB file storage
- 1 GB bandwidth

**Perfect for this project!** A few hundred comic pages easily fits within limits.

### Replicate Costs
- Real-ESRGAN: ~$0.05-0.10 per image
- AI Damage Restoration: ~$0.10-0.20 per image
- Total: ~$0.20-0.30 per comic page

## Troubleshooting

### "Module not found" errors
- Make sure all imports use correct paths
- Convex functions run in a different context than local Node.js
- Use `import.meta.url` for local file access

### "REPLICATE_API_TOKEN not set"
- Check Convex Dashboard ‚Üí Settings ‚Üí Environment Variables
- Redeploy after adding: `npx convex deploy`

### Files not persisting
- Use `ctx.storage.store()` to save files
- Use `ctx.storage.get()` to retrieve files
- Don't rely on local file system

### Background job not running
- Check Convex Dashboard ‚Üí Logs for errors
- Ensure job is scheduled with `ctx.scheduler.runAfter()`
- Verify mutations are called with `await ctx.runMutation()`

## Monitoring

View logs and metrics in Convex Dashboard:
- **Functions** - See all deployed functions
- **Logs** - Real-time function logs
- **Data** - Browse database tables
- **Files** - View stored files

## Alternative: Keep Express + Convex

You can also keep the Express server and use Convex just for background jobs:

1. Keep `src/server.js` for HTTP endpoints
2. Use Convex only for `processRestorationJob`
3. Best of both worlds!

## Next Steps

1. **Deploy**: `npx convex deploy`
2. **Test**: Upload a comic page and start restoration
3. **Monitor**: Check Convex Dashboard for logs
4. **Optimize**: Add progress updates, error handling, retries

## Resources

- [Convex Docs](https://docs.convex.dev/)
- [HTTP Actions](https://docs.convex.dev/functions/http-actions)
- [File Storage](https://docs.convex.dev/file-storage)
- [Background Jobs](https://docs.convex.dev/scheduling/scheduled-functions)
- [Replicate API](https://replicate.com/docs)

## Comparison: Convex vs Vercel

| Feature | Convex | Vercel (Hobby) |
|---------|--------|----------------|
| Timeout | ‚ôæÔ∏è Unlimited | 10 seconds |
| File Storage | ‚úÖ Built-in (1GB free) | ‚ùå Temporary only |
| Real-time | ‚úÖ Built-in | ‚ùå Needs polling |
| Background Jobs | ‚úÖ Native support | ‚ùå Not available |
| Cost | Free tier: 1M calls/month | Free tier: Limited functions |
| Best for | AI/ML, file processing | Static sites, quick APIs |

**Winner for this project: Convex! üéâ**
